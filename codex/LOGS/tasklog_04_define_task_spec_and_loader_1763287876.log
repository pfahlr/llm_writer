OpenAI Codex v0.57.0 (research preview)
--------
workdir: /var/home/rick/Development/llm_writer
model: gpt-5-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: high
reasoning summaries: auto
session id: 019a8c25-c342-7c73-9380-8b2e05478ff5
--------
user
Implement the functionality described in codex/TASKS/04_define_task_spec_and_loader.yaml, then verify with any available tests.
ERROR: MCP client for `context7-mcp` failed to start: handshaking with MCP server failed: connection closed: initialize response
ERROR: MCP client for `exa` failed to start: handshaking with MCP server failed: connection closed: initialize response
ERROR: MCP client for `vibe-check-mcp-server` failed to start: handshaking with MCP server failed: connection closed: initialize response
ERROR: MCP client for `mcp` failed to start: handshaking with MCP server failed: connection closed: initialize response

thinking
**Preparing to list files**
exec
bash -lc ls in /var/home/rick/Development/llm_writer succeeded in 38ms:
AGENTS.md
codex
codex.toml
pyproject.toml
README.md
requirements.txt
src
tests
venv

thinking
**Opening task file**
exec
bash -lc 'ls codex/TASKS' in /var/home/rick/Development/llm_writer succeeded in 38ms:
01_bootstrap_project_and_cli.yaml
02_implement_config_models_and_loader.yaml
03_implement_model_registry_and_litellm_integration.yaml
04_define_task_spec_and_loader.yaml
05_implement_prompt_builders.yaml
06_implement_mcp_types_and_normalization.yaml
07_implement_automated_task_runner.yaml
08_implement_planning_log_writer.yaml
09_implement_planning_repl.yaml
10_implement_replay_support.yaml
11_implement_mcp_prompt_policy_modes.yaml
12_add_textual_source_browser_stub.yaml
CODEX_TODO.md
master_spec.yaml
work_list

thinking
**Reading instruction file 04**
exec
bash -lc 'cat codex/TASKS/04_define_task_spec_and_loader.yaml' in /var/home/rick/Development/llm_writer succeeded in 38ms:
id: 04
filename: 04_define_task_spec_and_loader.yaml
title: Define TaskSpec, references, and loader
description: >
  Finalize TaskSpec and reference models for YAML-defined writing tasks,
  and implement loader helpers to load individual tasks and expand glob
  patterns into concrete paths.

dependencies:
  - 02

goals:
  - TaskSpec schema supports:
    - title, id, description, context, references, output, model,
      model_params, mcp_error_mode, style.
  - References support URL and MCP sources with per-reference overrides.
  - Loader functions can read a YAML file into TaskSpec and expand globs.

artifacts:
  - src/simple_rag_writer/tasks/models.py

thinking
**Reviewing source and test directories**
exec
bash -lc 'ls src/simple_rag_writer' in /var/home/rick/Development/llm_writer succeeded in 39ms:
cli
config
__init__.py
llm
logging
mcp
planning
prompts
__pycache__
replay
runner
tasks

thinking
**Reviewing tasks module**
exec
bash -lc 'ls src/simple_rag_writer/tasks' in /var/home/rick/Development/llm_writer succeeded in 40ms:
__init__.py
loader.py
models.py
__pycache__

thinking
**Checking current models and loader**
exec
bash -lc "sed -n '1,200p' src/simple_rag_writer/tasks/models.py" in /var/home/rick/Development/llm_writer succeeded in 38ms:
from __future__ import annotations

from typing import Any, Dict, List, Optional

from pydantic import BaseModel, Field


class ContextSpec(BaseModel):
  outline_path: Optional[str] = None
  outline_id: Optional[str] = None


class ReferenceCommon(BaseModel):
  type: str
  label: Optional[str] = None
  item_type: Optional[str] = None
  prompt_mode: Optional[str] = None
  max_items: Optional[int] = None
  max_chars: Optional[int] = None
  summary_max_tokens: Optional[int] = None

thinking
**Checking for override support**
exec
bash -lc "sed -n '1,200p' src/simple_rag_writer/tasks/loader.py" in /var/home/rick/Development/llm_writer succeeded in 39ms:
from __future__ import annotations

import glob
from pathlib import Path
from typing import Iterable, List

import yaml

from .models import TaskSpec


def load_task(path: Path) -> TaskSpec:
  with path.open("r", encoding="utf-8") as f:
    raw = yaml.safe_load(f) or {}
  return TaskSpec(**raw)


def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
  result: List[Path] = []
  for p in paths:

thinking
**Verifying deduplication and reference overrides**
exec
bash -lc 'rg -n "Reference" -n src/simple_rag_writer -n tests -g"*"' in /var/home/rick/Development/llm_writer succeeded in 41ms:
src/simple_rag_writer/tasks/models.py:13:class ReferenceCommon(BaseModel):
src/simple_rag_writer/tasks/models.py:23:class UrlReference(ReferenceCommon):
src/simple_rag_writer/tasks/models.py:28:class McpReference(ReferenceCommon):
src/simple_rag_writer/tasks/models.py:35:ReferenceSpec = UrlReference | McpReference
src/simple_rag_writer/tasks/models.py:43:  references: List[ReferenceSpec] = Field(default_factory=list)
src/simple_rag_writer/logging/planning_log.py:77:    self._fh.write("### MCP References Injected\n\n")
src/simple_rag_writer/prompts/task_prompt.py:23:    parts.append("\n\n## Reference material\n")
src/simple_rag_writer/prompts/task_prompt.py:25:      parts.append(f"\n### Reference {idx}\n")

thinking
**Inspecting prompt fields**
exec
bash -lc "sed -n '1,200p' src/simple_rag_writer/prompts/task_prompt.py" in /var/home/rick/Development/llm_writer succeeded in 38ms:
from __future__ import annotations

from typing import List, Optional

from simple_rag_writer.tasks.models import TaskSpec


def build_task_prompt(
  task: TaskSpec,
  outline_context: Optional[str],
  reference_blobs: List[str],
) -> str:
  parts: List[str] = []
  parts.append(f"# Task: {task.title}\n")
  parts.append("## Description\n")
  parts.append(task.description)
  if task.style:
    parts.append(f"\n\nStyle: {task.style}")
  if outline_context:
    parts.append("\n\n## Outline context\n")

thinking
**Preparing test file for task loading**
exec
bash -lc 'ls tests' in /var/home/rick/Development/llm_writer succeeded in 38ms:
conftest.py
__pycache__
test_cli_parser.py
test_config_loader.py
test_llm_registry.py

thinking
**Planning test-driven development steps**
Plan update
  → Review existing task models/loader and inspect task spec requirements
  • Add failing tests covering task loading and glob logic per spec
  • Implement TaskSpec model updates and loader changes until tests pass

thinking
**Outlining tests for task loading**
Plan update
  ✓ Review existing task models/loader and inspect task spec requirements
  → Add failing tests covering task loading and glob logic per spec
  • Implement TaskSpec model updates and loader changes until tests pass

thinking
**Designing failing tests for missing features**
exec
bash -lc 'rg -n "mcp_error_mode" -n' in /var/home/rick/Development/llm_writer succeeded in 136ms:
codex/LOGS/tasklog_04_define_task_spec_and_loader_1763287876.log:71:      model_params, mcp_error_mode, style.
codex/LOGS/tasklog_04_define_task_spec_and_loader_1763287876.log:219:bash -lc 'rg -n "mcp_error_mode" -n' in /var/home/rick/Development/llm_writer
src/simple_rag_writer/tasks/models.py:47:  mcp_error_mode: str = "skip_with_warning"
src/simple_rag_writer/runner/run_tasks.py:48:            if task.mcp_error_mode == "fail_task":
codex/TASKS/07_implement_automated_task_runner.yaml:21:  - mcp_error_mode is honored ("skip_with_warning" vs "fail_task") for MCP
codex/TASKS/04_define_task_spec_and_loader.yaml:15:      model_params, mcp_error_mode, style.
codex/TASKS/04_define_task_spec_and_loader.yaml:29:  - Ensure TaskSpec.mcp_error_mode defaults to "skip_with_warning".
codex/TASKS/04_define_task_spec_and_loader.yaml:38:    - Verifying default values for mcp_error_mode and model_params.
codex/TASKS/master_spec.yaml:539:    mcp_error_mode:
codex/TASKS/master_spec.yaml:589:    mcp_error_mode: "skip_with_warning"
codex/TASKS/master_spec.yaml:762:        apply MCP prompt policy and mcp_error_mode, call model, write output.
codex/TASKS/master_spec.yaml:811:                - If task.mcp_error_mode == "skip_with_warning":
codex/TASKS/master_spec.yaml:813:                - If task.mcp_error_mode == "fail_task":

thinking
**Inspecting master spec section**
exec
bash -lc "sed -n '500,650p' codex/TASKS/master_spec.yaml" in /var/home/rick/Development/llm_writer succeeded in 38ms:
              type: string
              required: true
              description: "MCP server id (must match config.mcp_servers[].id)."
            tool:
              type: string
              required: true
              description: "Tool name exposed by that MCP server."
            params:
              type: map<string, any>
              required: false
              default: {}
              description: "Opaque, tool-specific parameters (e.g., query, limit)."
    output:
      type: string
      required: true
      description: "Path to the output Markdown file to be written."
    model:
      type: string
      required: false
      description: >

thinking
**Searching for references_schema**
exec
bash -lc 'rg -n "references" -n codex/TASKS/master_spec.yaml | head' in /var/home/rick/Development/llm_writer succeeded in 90ms:
102:        - Resolves zero or more references (URL/MCP).
241:            description: "Logical name used in task references (e.g., notes, papers)."
446:    references:
450:      description: "External references to use as context (URLs, MCP tools, etc.)."
565:    references:
646:        writing, and per-turn logging (including inline MCP references).
736:            fenced_block_key: "references"
761:        Task orchestration: resolve outline context, resolve MCP/url references,
847:          - MCP references from the 'mcp-yaml' fenced block (if present).

thinking
**Searching for spec references near line 446**
exec
bash -lc "sed -n '446,520p' codex/TASKS/master_spec.yaml" in /var/home/rick/Development/llm_writer succeeded in 40ms:
    references:
      type: list<ReferenceSpec>
      required: false
      default: []
      description: "External references to use as context (URLs, MCP tools, etc.)."
      ReferenceSpec:
        common_fields:
          type:
            type: string
            required: true
            enum: ["url", "mcp"]
          label:
            type: string
            required: false
            description: "Optional friendly label used in the prompt."
          item_type:
            type: string
            required: false
            description: >
              Hint for the logical type of items returned from this MCP

thinking
**Designing tests for task loading and path expansion**

I'm laying out detailed plans for tests to verify task loading, reference defaults, and especially the glob path expansion with deduplication preserving insertion order rather than sorting, aiming to catch current behavior that sorts paths and thus fails desired tests. This includes testing context, model params defaults, and per-reference overrides.
file update
A /var/home/rick/Development/llm_writer/tests/test_task_loading.py
from __future__ import annotations

from pathlib import Path
from textwrap import dedent

import pytest

from simple_rag_writer.tasks.loader import expand_task_paths, load_task


def _write_task(tmp_path: Path, name: str, body: str) -> Path:
  path = tmp_path / name
  path.write_text(dedent(body), encoding="utf-8")
  return path


def test_load_minimal_task_spec(tmp_path: Path) -> None:
  task_path = _write_task(
    tmp_path,
    "task_minimal.yaml",
    """
    title: "Chapter Prelude"
    id: "book1-prelude"
    description: "Draft the prelude."
    output: "drafts/prelude.md"
    """,
  )

  task = load_task(task_path)

  assert task.title == "Chapter Prelude"
  assert task.id == "book1-prelude"
  assert task.references == []
  assert task.context is None
  assert task.model is None
  assert task.model_params == {}
  assert task.mcp_error_mode == "skip_with_warning"
  assert task.output == "drafts/prelude.md"


def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
  task_path = _write_task(
    tmp_path,
    "task_with_refs.yaml",
    """
    title: "Case Study"
    id: "case-01"
    description: "Summarize a case."
    output: "drafts/case.md"
    references:
      - type: "url"
        label: "Spec"
        url: "https://example.com/spec"
        prompt_mode: "summary"
        max_items: 3
      - type: "mcp"
        label: "Case notes"
        server: "notes"
        tool: "search_notes"
        item_type: "note"
        params:
          query: "case alpha"
    """,
  )

  task = load_task(task_path)

  assert len(task.references) == 2
  url_ref = task.references[0]
  assert url_ref.type == "url"
  assert url_ref.url == "https://example.com/spec"
  assert url_ref.label == "Spec"
  assert url_ref.prompt_mode == "summary"
  assert url_ref.max_items == 3

  mcp_ref = task.references[1]
  assert mcp_ref.type == "mcp"
  assert mcp_ref.server == "notes"
  assert mcp_ref.tool == "search_notes"
  assert mcp_ref.item_type == "note"
  assert mcp_ref.params == {"query": "case alpha"}


def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
  second = _write_task(
    tmp_path,
    "b_task.yaml",
    """
    title: "Second"
    id: "b"
    description: "Second task"
    output: "drafts/b.md"
    """,
  ).resolve()
  first = _write_task(
    tmp_path,
    "a_task.yaml",
    """
    title: "First"
    id: "a"
    description: "First task"
    output: "drafts/a.md"
    """,
  ).resolve()

  expanded = expand_task_paths(
    [
      second,
      tmp_path / "*.yaml",
    ]
  )

  assert expanded == [second, first]
apply_patch(auto_approved=true) exited 0 in 5ms:
Success. Updated the following files:
A tests/test_task_loading.py
file update:
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..4b52a088e0461b4c6e4257275f120bfc62c2095d
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,113 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+import pytest
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]

file update:
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..4b52a088e0461b4c6e4257275f120bfc62c2095d
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,113 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+import pytest
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Cleaning up imports**
file update
M /var/home/rick/Development/llm_writer/tests/test_task_loading.py
@@ -5,4 +5,2 @@
 
-import pytest
-
 from simple_rag_writer.tasks.loader import expand_task_paths, load_task
apply_patch(auto_approved=true) exited 0 in 5ms:
Success. Updated the following files:
M tests/test_task_loading.py
file update:
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]

file update:
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Running tests to confirm behavior**
exec
bash -lc 'pytest tests/test_task_loading.py' in /var/home/rick/Development/llm_writer exited 1 in 1.26s:
============================= test session starts ==============================
platform linux -- Python 3.13.9, pytest-8.4.2, pluggy-1.6.0
rootdir: /var/home/rick/Development/llm_writer
configfile: pyproject.toml
plugins: Faker-37.8.0, xdist-3.8.0, mock-3.15.1, metadata-3.1.1, cov-7.0.0, asyncio-1.2.0, html-4.1.1, hypothesis-6.141.1, anyio-4.8.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 3 items

tests/test_task_loading.py ..F                                           [100%]

=================================== FAILURES ===================================
_________________ test_expand_task_paths_with_globs_and_dedup __________________

tmp_path = PosixPath('/tmp/pytest-of-rick/pytest-6/test_expand_task_paths_with_gl0')

    def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
      second = _write_task(
        tmp_path,
        "b_task.yaml",
        """
file update:
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Updating plan progress**
Plan update
  ✓ Review existing task models/loader and inspect task spec requirements
  ✓ Add failing tests covering task loading and glob logic per spec
  → Implement TaskSpec model updates and loader changes until tests pass
file update:
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Updating path expansion logic**

I'm revising `expand_task_paths` to preserve the first occurrence order while deduplicating resolved paths, ensuring glob results are sorted for consistent behavior. I'll convert all entries to resolved `Path` objects, track seen paths in a set, and update the implementation and tests accordingly.
file update
M /var/home/rick/Development/llm_writer/src/simple_rag_writer/tasks/loader.py
@@ -4,3 +4,3 @@
 from pathlib import Path
-from typing import Iterable, List
+from typing import Iterable, List, Set
 
@@ -18,11 +18,17 @@
 def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
-  result: List[Path] = []
+  ordered: List[Path] = []
+  seen: Set[Path] = set()
   for p in paths:
     s = str(p)
-    if any(ch in s for ch in ["*", "?", "["]):
-      for g in glob.glob(s):
-        result.append(Path(g))
-    else:
-      result.append(p)
-  unique = sorted({p.resolve() for p in result})
-  return unique
+    candidates = (
+      sorted(Path(g) for g in glob.glob(s))
+      if any(ch in s for ch in ["*", "?", "["])
+      else [Path(p)]
+    )
+    for candidate in candidates:
+      resolved = candidate.resolve()
+      if resolved in seen:
+        continue
+      seen.add(resolved)
+      ordered.append(resolved)
+  return ordered
apply_patch(auto_approved=true) exited 0 in 6ms:
Success. Updated the following files:
M src/simple_rag_writer/tasks/loader.py
file update:
diff --git a/src/simple_rag_writer/tasks/loader.py b/src/simple_rag_writer/tasks/loader.py
index f0a9c178a5c5c9f5092157f68cfd6dadb34df597..fc4f76fa4dd54be6677b9d5da2e0416ec9879845
--- a/src/simple_rag_writer/tasks/loader.py
+++ b/src/simple_rag_writer/tasks/loader.py
@@ -2,7 +2,7 @@
 
 import glob
 from pathlib import Path
-from typing import Iterable, List
+from typing import Iterable, List, Set
 
 import yaml
 
@@ -16,13 +16,19 @@
 
 
 def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
-  result: List[Path] = []
+  ordered: List[Path] = []
+  seen: Set[Path] = set()
   for p in paths:
     s = str(p)
-    if any(ch in s for ch in ["*", "?", "["]):
-      for g in glob.glob(s):
-        result.append(Path(g))
-    else:
-      result.append(p)
-  unique = sorted({p.resolve() for p in result})
-  return unique
+    candidates = (
+      sorted(Path(g) for g in glob.glob(s))
+      if any(ch in s for ch in ["*", "?", "["])
+      else [Path(p)]
+    )
+    for candidate in candidates:
+      resolved = candidate.resolve()
+      if resolved in seen:
+        continue
+      seen.add(resolved)
+      ordered.append(resolved)
+  return ordered
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]

file update:
diff --git a/src/simple_rag_writer/tasks/loader.py b/src/simple_rag_writer/tasks/loader.py
index f0a9c178a5c5c9f5092157f68cfd6dadb34df597..fc4f76fa4dd54be6677b9d5da2e0416ec9879845
--- a/src/simple_rag_writer/tasks/loader.py
+++ b/src/simple_rag_writer/tasks/loader.py
@@ -2,7 +2,7 @@
 
 import glob
 from pathlib import Path
-from typing import Iterable, List
+from typing import Iterable, List, Set
 
 import yaml
 
@@ -16,13 +16,19 @@
 
 
 def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
-  result: List[Path] = []
+  ordered: List[Path] = []
+  seen: Set[Path] = set()
   for p in paths:
     s = str(p)
-    if any(ch in s for ch in ["*", "?", "["]):
-      for g in glob.glob(s):
-        result.append(Path(g))
-    else:
-      result.append(p)
-  unique = sorted({p.resolve() for p in result})
-  return unique
+    candidates = (
+      sorted(Path(g) for g in glob.glob(s))
+      if any(ch in s for ch in ["*", "?", "["])
+      else [Path(p)]
+    )
+    for candidate in candidates:
+      resolved = candidate.resolve()
+      if resolved in seen:
+        continue
+      seen.add(resolved)
+      ordered.append(resolved)
+  return ordered
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Running targeted tests**
exec
bash -lc 'pytest tests/test_task_loading.py' in /var/home/rick/Development/llm_writer succeeded in 1.24s:
============================= test session starts ==============================
platform linux -- Python 3.13.9, pytest-8.4.2, pluggy-1.6.0
rootdir: /var/home/rick/Development/llm_writer
configfile: pyproject.toml
plugins: Faker-37.8.0, xdist-3.8.0, mock-3.15.1, metadata-3.1.1, cov-7.0.0, asyncio-1.2.0, html-4.1.1, hypothesis-6.141.1, anyio-4.8.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 3 items

tests/test_task_loading.py ...                                           [100%]

============================== 3 passed in 0.46s ===============================
file update:
diff --git a/src/simple_rag_writer/tasks/loader.py b/src/simple_rag_writer/tasks/loader.py
index f0a9c178a5c5c9f5092157f68cfd6dadb34df597..fc4f76fa4dd54be6677b9d5da2e0416ec9879845
--- a/src/simple_rag_writer/tasks/loader.py
+++ b/src/simple_rag_writer/tasks/loader.py
@@ -2,7 +2,7 @@
 
 import glob
 from pathlib import Path
-from typing import Iterable, List
+from typing import Iterable, List, Set
 
 import yaml
 
@@ -16,13 +16,19 @@
 
 
 def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
-  result: List[Path] = []
+  ordered: List[Path] = []
+  seen: Set[Path] = set()
   for p in paths:
     s = str(p)
-    if any(ch in s for ch in ["*", "?", "["]):
-      for g in glob.glob(s):
-        result.append(Path(g))
-    else:
-      result.append(p)
-  unique = sorted({p.resolve() for p in result})
-  return unique
+    candidates = (
+      sorted(Path(g) for g in glob.glob(s))
+      if any(ch in s for ch in ["*", "?", "["])
+      else [Path(p)]
+    )
+    for candidate in candidates:
+      resolved = candidate.resolve()
+      if resolved in seen:
+        continue
+      seen.add(resolved)
+      ordered.append(resolved)
+  return ordered
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Running all tests**
exec
bash -lc pytest in /var/home/rick/Development/llm_writer succeeded in 1.38s:
============================= test session starts ==============================
platform linux -- Python 3.13.9, pytest-8.4.2, pluggy-1.6.0
rootdir: /var/home/rick/Development/llm_writer
configfile: pyproject.toml
testpaths: tests
plugins: Faker-37.8.0, xdist-3.8.0, mock-3.15.1, metadata-3.1.1, cov-7.0.0, asyncio-1.2.0, html-4.1.1, hypothesis-6.141.1, anyio-4.8.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 12 items

tests/test_cli_parser.py ..                                              [ 16%]
tests/test_config_loader.py ...                                          [ 41%]
tests/test_llm_registry.py ....                                          [ 75%]
tests/test_task_loading.py ...                                           [100%]

============================== 12 passed in 0.59s ==============================
file update:
diff --git a/src/simple_rag_writer/tasks/loader.py b/src/simple_rag_writer/tasks/loader.py
index f0a9c178a5c5c9f5092157f68cfd6dadb34df597..fc4f76fa4dd54be6677b9d5da2e0416ec9879845
--- a/src/simple_rag_writer/tasks/loader.py
+++ b/src/simple_rag_writer/tasks/loader.py
@@ -2,7 +2,7 @@
 
 import glob
 from pathlib import Path
-from typing import Iterable, List
+from typing import Iterable, List, Set
 
 import yaml
 
@@ -16,13 +16,19 @@
 
 
 def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
-  result: List[Path] = []
+  ordered: List[Path] = []
+  seen: Set[Path] = set()
   for p in paths:
     s = str(p)
-    if any(ch in s for ch in ["*", "?", "["]):
-      for g in glob.glob(s):
-        result.append(Path(g))
-    else:
-      result.append(p)
-  unique = sorted({p.resolve() for p in result})
-  return unique
+    candidates = (
+      sorted(Path(g) for g in glob.glob(s))
+      if any(ch in s for ch in ["*", "?", "["])
+      else [Path(p)]
+    )
+    for candidate in candidates:
+      resolved = candidate.resolve()
+      if resolved in seen:
+        continue
+      seen.add(resolved)
+      ordered.append(resolved)
+  return ordered
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Finalizing plan update**
Plan update
  ✓ Review existing task models/loader and inspect task spec requirements
  ✓ Add failing tests covering task loading and glob logic per spec
  ✓ Implement TaskSpec model updates and loader changes until tests pass
file update:
diff --git a/src/simple_rag_writer/tasks/loader.py b/src/simple_rag_writer/tasks/loader.py
index f0a9c178a5c5c9f5092157f68cfd6dadb34df597..fc4f76fa4dd54be6677b9d5da2e0416ec9879845
--- a/src/simple_rag_writer/tasks/loader.py
+++ b/src/simple_rag_writer/tasks/loader.py
@@ -2,7 +2,7 @@
 
 import glob
 from pathlib import Path
-from typing import Iterable, List
+from typing import Iterable, List, Set
 
 import yaml
 
@@ -16,13 +16,19 @@
 
 
 def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
-  result: List[Path] = []
+  ordered: List[Path] = []
+  seen: Set[Path] = set()
   for p in paths:
     s = str(p)
-    if any(ch in s for ch in ["*", "?", "["]):
-      for g in glob.glob(s):
-        result.append(Path(g))
-    else:
-      result.append(p)
-  unique = sorted({p.resolve() for p in result})
-  return unique
+    candidates = (
+      sorted(Path(g) for g in glob.glob(s))
+      if any(ch in s for ch in ["*", "?", "["])
+      else [Path(p)]
+    )
+    for candidate in candidates:
+      resolved = candidate.resolve()
+      if resolved in seen:
+        continue
+      seen.add(resolved)
+      ordered.append(resolved)
+  return ordered
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Checking git status**
exec
bash -lc 'git status -sb' in /var/home/rick/Development/llm_writer succeeded in 39ms:
## main
?? codex/LOGS/codex_run_2025-11-16_04-58-12.log
?? codex/LOGS/tasklog_01_bootstrap_project_and_cli_1763287092.log
?? codex/LOGS/tasklog_01_bootstrap_project_and_cli_1763287092.log.done
?? codex/LOGS/tasklog_02_implement_config_models_and_loader_1763287503.log
?? codex/LOGS/tasklog_02_implement_config_models_and_loader_1763287503.log.done
?? codex/LOGS/tasklog_03_implement_model_registry_and_litellm_integration_1763287725.log
?? codex/LOGS/tasklog_03_implement_model_registry_and_litellm_integration_1763287725.log.done
?? codex/LOGS/tasklog_04_define_task_spec_and_loader_1763287876.log
?? src/
?? tests/__pycache__/
?? tests/conftest.py
?? tests/test_cli_parser.py
?? tests/test_task_loading.py
file update:
diff --git a/src/simple_rag_writer/tasks/loader.py b/src/simple_rag_writer/tasks/loader.py
index f0a9c178a5c5c9f5092157f68cfd6dadb34df597..fc4f76fa4dd54be6677b9d5da2e0416ec9879845
--- a/src/simple_rag_writer/tasks/loader.py
+++ b/src/simple_rag_writer/tasks/loader.py
@@ -2,7 +2,7 @@
 
 import glob
 from pathlib import Path
-from typing import Iterable, List
+from typing import Iterable, List, Set
 
 import yaml
 
@@ -16,13 +16,19 @@
 
 
 def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
-  result: List[Path] = []
+  ordered: List[Path] = []
+  seen: Set[Path] = set()
   for p in paths:
     s = str(p)
-    if any(ch in s for ch in ["*", "?", "["]):
-      for g in glob.glob(s):
-        result.append(Path(g))
-    else:
-      result.append(p)
-  unique = sorted({p.resolve() for p in result})
-  return unique
+    candidates = (
+      sorted(Path(g) for g in glob.glob(s))
+      if any(ch in s for ch in ["*", "?", "["])
+      else [Path(p)]
+    )
+    for candidate in candidates:
+      resolved = candidate.resolve()
+      if resolved in seen:
+        continue
+      seen.add(resolved)
+      ordered.append(resolved)
+  return ordered
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Preparing final summary details**
exec
bash -lc 'nl -ba tests/test_task_loading.py' in /var/home/rick/Development/llm_writer succeeded in 38ms:
     1	from __future__ import annotations
     2	
     3	from pathlib import Path
     4	from textwrap import dedent
     5	
     6	from simple_rag_writer.tasks.loader import expand_task_paths, load_task
     7	
     8	
     9	def _write_task(tmp_path: Path, name: str, body: str) -> Path:
    10	  path = tmp_path / name
    11	  path.write_text(dedent(body), encoding="utf-8")
    12	  return path
    13	
    14	
    15	def test_load_minimal_task_spec(tmp_path: Path) -> None:
    16	  task_path = _write_task(
    17	    tmp_path,
    18	    "task_minimal.yaml",
    19	    """
    20	    title: "Chapter Prelude"
file update:
diff --git a/src/simple_rag_writer/tasks/loader.py b/src/simple_rag_writer/tasks/loader.py
index f0a9c178a5c5c9f5092157f68cfd6dadb34df597..fc4f76fa4dd54be6677b9d5da2e0416ec9879845
--- a/src/simple_rag_writer/tasks/loader.py
+++ b/src/simple_rag_writer/tasks/loader.py
@@ -2,7 +2,7 @@
 
 import glob
 from pathlib import Path
-from typing import Iterable, List
+from typing import Iterable, List, Set
 
 import yaml
 
@@ -16,13 +16,19 @@
 
 
 def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
-  result: List[Path] = []
+  ordered: List[Path] = []
+  seen: Set[Path] = set()
   for p in paths:
     s = str(p)
-    if any(ch in s for ch in ["*", "?", "["]):
-      for g in glob.glob(s):
-        result.append(Path(g))
-    else:
-      result.append(p)
-  unique = sorted({p.resolve() for p in result})
-  return unique
+    candidates = (
+      sorted(Path(g) for g in glob.glob(s))
+      if any(ch in s for ch in ["*", "?", "["])
+      else [Path(p)]
+    )
+    for candidate in candidates:
+      resolved = candidate.resolve()
+      if resolved in seen:
+        continue
+      seen.add(resolved)
+      ordered.append(resolved)
+  return ordered
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Adding line numbers for loader file changes**
exec
bash -lc 'nl -ba src/simple_rag_writer/tasks/loader.py' in /var/home/rick/Development/llm_writer succeeded in 38ms:
     1	from __future__ import annotations
     2	
     3	import glob
     4	from pathlib import Path
     5	from typing import Iterable, List, Set
     6	
     7	import yaml
     8	
     9	from .models import TaskSpec
    10	
    11	
    12	def load_task(path: Path) -> TaskSpec:
    13	  with path.open("r", encoding="utf-8") as f:
    14	    raw = yaml.safe_load(f) or {}
    15	  return TaskSpec(**raw)
    16	
    17	
    18	def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
    19	  ordered: List[Path] = []
    20	  seen: Set[Path] = set()
file update:
diff --git a/src/simple_rag_writer/tasks/loader.py b/src/simple_rag_writer/tasks/loader.py
index f0a9c178a5c5c9f5092157f68cfd6dadb34df597..fc4f76fa4dd54be6677b9d5da2e0416ec9879845
--- a/src/simple_rag_writer/tasks/loader.py
+++ b/src/simple_rag_writer/tasks/loader.py
@@ -2,7 +2,7 @@
 
 import glob
 from pathlib import Path
-from typing import Iterable, List
+from typing import Iterable, List, Set
 
 import yaml
 
@@ -16,13 +16,19 @@
 
 
 def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
-  result: List[Path] = []
+  ordered: List[Path] = []
+  seen: Set[Path] = set()
   for p in paths:
     s = str(p)
-    if any(ch in s for ch in ["*", "?", "["]):
-      for g in glob.glob(s):
-        result.append(Path(g))
-    else:
-      result.append(p)
-  unique = sorted({p.resolve() for p in result})
-  return unique
+    candidates = (
+      sorted(Path(g) for g in glob.glob(s))
+      if any(ch in s for ch in ["*", "?", "["])
+      else [Path(p)]
+    )
+    for candidate in candidates:
+      resolved = candidate.resolve()
+      if resolved in seen:
+        continue
+      seen.add(resolved)
+      ordered.append(resolved)
+  return ordered
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]


thinking
**Summarizing final changes and tests**

I'll wrap up with a clear explanation of the code changes referencing specific files and lines, highlight the new tests verifying loader behavior and deduplication, mention running `pytest` to confirm everything, and propose a commit message while keeping next steps optional but minimal. This will neatly follow the instructions for a final structured summary.
codex
Changes focus on fleshing out the task loader spec and covering it with tests.

- Added regression tests for loading minimal specs, URL/MCP reference variants, and glob/dedup behavior so the schema expectations are captured directly (`tests/test_task_loading.py:15`, `tests/test_task_loading.py:39`, `tests/test_task_loading.py:82`).
- Reworked `expand_task_paths` to expand globs deterministically and keep the first-seen order while still deduplicating on resolved paths (`src/simple_rag_writer/tasks/loader.py:18`).

Suggested commit message: `feat: define task spec loader and coverage`

Tests:
- `pytest`
file update:
diff --git a/src/simple_rag_writer/tasks/loader.py b/src/simple_rag_writer/tasks/loader.py
index f0a9c178a5c5c9f5092157f68cfd6dadb34df597..fc4f76fa4dd54be6677b9d5da2e0416ec9879845
--- a/src/simple_rag_writer/tasks/loader.py
+++ b/src/simple_rag_writer/tasks/loader.py
@@ -2,7 +2,7 @@
 
 import glob
 from pathlib import Path
-from typing import Iterable, List
+from typing import Iterable, List, Set
 
 import yaml
 
@@ -16,13 +16,19 @@
 
 
 def expand_task_paths(paths: Iterable[Path]) -> List[Path]:
-  result: List[Path] = []
+  ordered: List[Path] = []
+  seen: Set[Path] = set()
   for p in paths:
     s = str(p)
-    if any(ch in s for ch in ["*", "?", "["]):
-      for g in glob.glob(s):
-        result.append(Path(g))
-    else:
-      result.append(p)
-  unique = sorted({p.resolve() for p in result})
-  return unique
+    candidates = (
+      sorted(Path(g) for g in glob.glob(s))
+      if any(ch in s for ch in ["*", "?", "["])
+      else [Path(p)]
+    )
+    for candidate in candidates:
+      resolved = candidate.resolve()
+      if resolved in seen:
+        continue
+      seen.add(resolved)
+      ordered.append(resolved)
+  return ordered
diff --git a/tests/test_task_loading.py b/tests/test_task_loading.py
new file mode 100644
index 0000000000000000000000000000000000000000..1ac8ebffc1ead0750ef936647f7c87b094000e6b
--- /dev/null
+++ b/tests/test_task_loading.py
@@ -0,0 +1,111 @@
+from __future__ import annotations
+
+from pathlib import Path
+from textwrap import dedent
+
+from simple_rag_writer.tasks.loader import expand_task_paths, load_task
+
+
+def _write_task(tmp_path: Path, name: str, body: str) -> Path:
+  path = tmp_path / name
+  path.write_text(dedent(body), encoding="utf-8")
+  return path
+
+
+def test_load_minimal_task_spec(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_minimal.yaml",
+    """
+    title: "Chapter Prelude"
+    id: "book1-prelude"
+    description: "Draft the prelude."
+    output: "drafts/prelude.md"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert task.title == "Chapter Prelude"
+  assert task.id == "book1-prelude"
+  assert task.references == []
+  assert task.context is None
+  assert task.model is None
+  assert task.model_params == {}
+  assert task.mcp_error_mode == "skip_with_warning"
+  assert task.output == "drafts/prelude.md"
+
+
+def test_load_task_with_url_and_mcp_references(tmp_path: Path) -> None:
+  task_path = _write_task(
+    tmp_path,
+    "task_with_refs.yaml",
+    """
+    title: "Case Study"
+    id: "case-01"
+    description: "Summarize a case."
+    output: "drafts/case.md"
+    references:
+      - type: "url"
+        label: "Spec"
+        url: "https://example.com/spec"
+        prompt_mode: "summary"
+        max_items: 3
+      - type: "mcp"
+        label: "Case notes"
+        server: "notes"
+        tool: "search_notes"
+        item_type: "note"
+        params:
+          query: "case alpha"
+    """,
+  )
+
+  task = load_task(task_path)
+
+  assert len(task.references) == 2
+  url_ref = task.references[0]
+  assert url_ref.type == "url"
+  assert url_ref.url == "https://example.com/spec"
+  assert url_ref.label == "Spec"
+  assert url_ref.prompt_mode == "summary"
+  assert url_ref.max_items == 3
+
+  mcp_ref = task.references[1]
+  assert mcp_ref.type == "mcp"
+  assert mcp_ref.server == "notes"
+  assert mcp_ref.tool == "search_notes"
+  assert mcp_ref.item_type == "note"
+  assert mcp_ref.params == {"query": "case alpha"}
+
+
+def test_expand_task_paths_with_globs_and_dedup(tmp_path: Path) -> None:
+  second = _write_task(
+    tmp_path,
+    "b_task.yaml",
+    """
+    title: "Second"
+    id: "b"
+    description: "Second task"
+    output: "drafts/b.md"
+    """,
+  ).resolve()
+  first = _write_task(
+    tmp_path,
+    "a_task.yaml",
+    """
+    title: "First"
+    id: "a"
+    description: "First task"
+    output: "drafts/a.md"
+    """,
+  ).resolve()
+
+  expanded = expand_task_paths(
+    [
+      second,
+      tmp_path / "*.yaml",
+    ]
+  )
+
+  assert expanded == [second, first]

tokens used
47,533
Changes focus on fleshing out the task loader spec and covering it with tests.

- Added regression tests for loading minimal specs, URL/MCP reference variants, and glob/dedup behavior so the schema expectations are captured directly (`tests/test_task_loading.py:15`, `tests/test_task_loading.py:39`, `tests/test_task_loading.py:82`).
- Reworked `expand_task_paths` to expand globs deterministically and keep the first-seen order while still deduplicating on resolved paths (`src/simple_rag_writer/tasks/loader.py:18`).

Suggested commit message: `feat: define task spec loader and coverage`

Tests:
- `pytest`
